<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>True Sight</title>
  <meta name="theme-color" content="#222">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <!-- For Samsung Internet -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="True Sight">
  <!-- iOS PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
</head>
<body>
  <div class="container">
    <header>
      <h1>TRUE SIGHT</h1>
    </header>
    
    <main>
      <!-- Link Submission Form -->
      <form id="linkForm" class="link-box">
        <input type="text" id="linkInput" placeholder="Paste your link here" required>
        <div class="button-group">
          <button type="button" id="pasteBtn"><i class="fas fa-paste"></i> Paste</button>
          <button type="submit" id="sendBtn"><i class="fas fa-arrow-right"></i></button>
        </div>
      </form>
      <div id="linkStatus" class="status-message"></div>
      
      <div class="divider">
        <span>-------------------- OR --------------------</span>
      </div>
      
      <!-- File Upload Form -->
      <form id="uploadForm" class="drop-zone">
        <input type="file" id="fileInput" accept=".mp4,.mov,.jpg,.png" style="display: none;">
        <label for="fileInput" class="file-upload-label">
          <i class="fas fa-cloud-upload-alt cloud-icon"></i>
          <p>Supported files: .mp4, .mov, .jpg, .png</p>
          <p class="hint">(Click or drag files here)</p>
        </label>
        <div id="selectedFileName" class="selected-file"></div>
        <button type="submit" id="uploadBtn" class="upload-button" disabled>
          <i class="fas fa-paper-plane"></i> Analyze File
        </button>
        <div id="uploadStatus" class="status-message"></div>
      </form>
    </main>
  </div>

  <script src="/app.js"></script>
  
  <script>
    // Link Submission Logic with Debugging
    const linkForm = document.getElementById('linkForm');
    const linkInput = document.getElementById('linkInput');
    const sendBtn = document.getElementById('sendBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    const linkStatus = document.getElementById('linkStatus');

    // Enhanced paste button with error handling
    pasteBtn.addEventListener('click', async () => {
      try {
        const permission = await navigator.permissions.query({ name: 'clipboard-read' });
        if (permission.state === 'denied') {
          throw new Error('Clipboard permission denied');
        }
        const text = await navigator.clipboard.readText();
        linkInput.value = text;
        linkStatus.textContent = 'Pasted from clipboard!';
        linkStatus.style.color = 'green';
        setTimeout(() => linkStatus.textContent = '', 2000);
      } catch (err) {
        console.error('Clipboard error:', err);
        linkStatus.textContent = 'Clipboard access failed - paste manually';
        linkStatus.style.color = 'red';
        setTimeout(() => linkStatus.textContent = '', 3000);
      }
    });

    // Enhanced link submission with debugging
    linkForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const link = linkInput.value.trim();
      if (!link) {
        linkStatus.textContent = 'Please enter a link first';
        linkStatus.style.color = 'red';
        return;
      }
      
      sendBtn.disabled = true;
      linkStatus.textContent = 'Analyzing link...';
      linkStatus.style.color = '#000';

      try {
        console.group('Link Submission Debug');
        console.log('Attempting to send link:', link);
        
        // Test backend connectivity first
        console.log('Testing backend connectivity...');
        const pingStart = Date.now();
        const pingResponse = await fetch('http://localhost:5000/ping', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        }).catch(() => null);
        
        if (!pingResponse || !pingResponse.ok) {
          throw new Error('Backend is not responding. Is your server running?');
        }
        console.log(`Backend ping successful (${Date.now() - pingStart}ms)`);

        // Send the actual request
        console.log('Sending analysis request...');
        const startTime = Date.now();
        const response = await fetch('http://localhost:5000/analyze', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ url: link })
        });
        const duration = Date.now() - startTime;
        
        console.log(`Received response in ${duration}ms`, response);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error('Backend error:', errorData);
          throw new Error(errorData.message || `Server error: ${response.status}`);
        }

        const result = await response.json();
        console.log('Analysis result:', result);
        
        linkStatus.textContent = 'Analysis complete!';
        linkStatus.style.color = 'green';
        
        // Optional: Redirect or display results
        if (result.redirectUrl) {
          window.location.href = result.redirectUrl;
        }
        
      } catch (error) {
        console.error('Full error:', error);
        
        // Detailed error messages
        if (error.message.includes('Failed to fetch')) {
          linkStatus.textContent = 'Connection failed - check backend server';
        } else if (error.message.includes('CORS')) {
          linkStatus.textContent = 'CORS error - check server configuration';
        } else {
          linkStatus.textContent = `Error: ${error.message}`;
        }
        
        linkStatus.style.color = 'red';
        
      } finally {
        console.groupEnd();
        sendBtn.disabled = false;
        
        // Add temporary debug button
        if (!document.getElementById('debugBtn')) {
          const debugBtn = document.createElement('button');
          debugBtn.id = 'debugBtn';
          debugBtn.textContent = 'View Debug Info';
          debugBtn.style.marginTop = '10px';
          debugBtn.onclick = () => {
            alert('Check browser console (F12) for detailed debug information');
          };
          linkStatus.after(debugBtn);
          setTimeout(() => debugBtn.remove(), 10000);
        }
      }
    });

    // Add temporary ping endpoint for testing
    setTimeout(async () => {
      try {
        const response = await fetch('http://localhost:5000/ping');
        console.log('Backend pre-check:', response.ok ? 'Connected' : 'Not ready');
      } catch (e) {
        console.warn('Backend not detected at startup:', e.message);
      }
    }, 1000);
</script>